---
title: "InvaCost Spatial Extrapolation"
author: "Gabriel Caetano, Ivan Jaric, Franck Courchamp"
date: "`r Sys.Date()`"
output: 
  pdf_document: default
  rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{pcpi} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

# To do

- How complete is our data? Map species overlap per country
- Find country-level predictors for each impacted sector (WorldBank database?)
- Filter appropriate data
- Filter only UN recognized countries? (Are these the only countries in WorldBank?)

# Set up

Install packages (turned off automatic evaluation so it doesn't try to intall them every time)

```{r, eval = FALSE}
install.packages("magrittr")
install.packages("stringr")
install.packages("rgbif")
install.packages("pbapply")
```

Load packages

```{r}
library(magrittr)
library(rgbif)
```

Load data

```{r}
inva_db <-
  read.csv("InvaCost_database_v4.1.csv")
```

# Data Exploration

What does the database looks like?

```{r}
head(inva_db)
```

It seems the there are a few data points with multiple species, countries and impacted sectors. Let's create a new table with only unique combinations.

```{r}
scs_df <-
  data.frame(
    Species = inva_db$Species,
    Official_country = inva_db$Official_country,
    Impacted_sector  = inva_db$Impacted_sector)

scs_unq <-
  lapply(1:nrow(scs_df), function(r){
    
    row <- scs_df[r,]
    #print(row.names(row))
    row.names(row) <- NULL
    
    which_multi <- stringr::str_detect(row, "/")
    
    if(!any(which_multi)) return(row)
    
    split_cases <-
      sapply(row[which_multi], stringr::str_split, "/")
    
    out <-
      do.call(expand.grid, split_cases) %>% 
      data.frame(row[!which_multi] )
    
    out[match(colnames(out), names(row))]
    
  }) %>% 
  do.call(rbind, .)

scs_unq <- 
  scs_unq[!stringr::str_detect(scs_unq$Species, "\\."),]

dim(scs_unq)
```

Fix some typos and remove unspecified countries and impact sector

```{r}
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Forestry " ] <- "Forestry"
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Foresty" ] <- "Forestry"
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Public and social welfare" ] <- "Public and Social Welfare"

scs_unq$Official_country[scs_unq$Official_country == "Kanya" ] <- "Kenya"
scs_unq$Official_country[scs_unq$Official_country == "Republic of Serbia" ] <- "Serbia"
scs_unq$Official_country[scs_unq$Official_country == "The Bahamas" ] <- "Bahamas"
scs_unq$Official_country[scs_unq$Official_country == "United Republic of Tanzania" ] <- "Tanzania"

scs_unq <- scs_unq[!scs_unq$Impacted_sector %in% c("Unspecified"),]
scs_unq <- scs_unq[!scs_unq$Official_country %in% c("31 countries",
                                                    "African Countries",
                                                    "Diverse",
                                                    "EU27+",
                                                    "Unspecified"),]

scs_unq <- scs_unq[!duplicated(scs_unq),]

dim(scs_unq)
```

# Get occurrence data for species from GBIF

Look up species names in GBIF taxonomy (this may take a while)

```{r, eval = FALSE}
gbif_lookup <- 
  pbapply::pblapply(unique(scs_unq$Species), 
                    rgbif::name_lookup, 
                    verbose = FALSE)

saveRDS(gbif_lookup, "gbif_lookup.rds")
```

See which names found no match on GBIF

```{r, eval = FALSE}
gbif_lookup <- readRDS("gbif_lookup.rds")

name_match <- 
  sapply(1:length(unique(scs_unq$Species)), 
         function(i){
           
           unique(scs_unq$Species)[i] %in%
             c(gbif_lookup[[i]]$data$species, 
               gbif_lookup[[i]]$data$scientificName)
           
         })

unique(scs_unq$Species)[!name_match]
```

Fix misspellings

```{r}
# Misspellings
scs_unq$Species[scs_unq$Species == "Felix catus"] <- "Felis catus"
scs_unq$Species[scs_unq$Species == "Rarrus rattus"] <- "Rattus rattus"
scs_unq$Species[scs_unq$Species == "italicum"] <- "Arum italicum"
scs_unq$Species[scs_unq$Species == "Cylindroptunia sp."] <- "Cylindropuntia sp."
scs_unq$Species[scs_unq$Species == "Bos taurus "] <- "Bos taurus"
scs_unq$Species[scs_unq$Species == "Andean ?otato latent tymovirus"] <- "Andean potato latent tymovirus"
scs_unq$Species[scs_unq$Species == " Proposis juliflora"] <- "Proposis juliflora"
scs_unq$Species[scs_unq$Species == " Proposis velutina"] <- "Proposis velutina"
scs_unq$Species[scs_unq$Species == " Solenopsis richteri"] <- "Solenopsis richteri"
scs_unq$Species[scs_unq$Species == "Gaeumannomyces graminis\x86var.\x86tritici"] <- "Gaeumannomyces graminis var. tritici"
scs_unq$Species[scs_unq$Species == "Spartina\xa0spp."] <- "Spartina spp."
scs_unq$Species[scs_unq$Species == "Candidatus\xa0liberibacter"] <- "Candidatus liberibacter"
scs_unq$Species[scs_unq$Species == "Casuarina equisetifolia "] <- "Casuarina equisetifolia"
scs_unq$Species[scs_unq$Species == "Tilletia Indica"] <- "Tilletia indica"
scs_unq$Species[scs_unq$Species == "Ralstonia Solanacearum"] <- "Ralstonia solanacearum"
scs_unq$Species[scs_unq$Species == "Pacifastacus Leniusculus"] <- "Pacifastacus leniusculus"
scs_unq$Species[scs_unq$Species == "Opuntia ficus-indica "] <- "Opuntia ficus-indica"
scs_unq$Species[scs_unq$Species == "Blatella germanica"] <- "Blattella germanica"
scs_unq$Species[scs_unq$Species == "Peach  rosette  mosaic  nepovirus "] <- "Peach  rosette  mosaic  nepovirus"
scs_unq$Species[scs_unq$Species == "Oligonychus metasequoia"] <- "Oligonychus metasequoiae" 
scs_unq$Species[scs_unq$Species == "Proposis pallida"] <- "Prosopis pallida"
scs_unq$Species[scs_unq$Species == "Proposis gladulosa"] <- "Prosopis gladulosa"
scs_unq$Species[scs_unq$Species == "Proposis juliflora"] <- "Prosopis juliflora"
scs_unq$Species[scs_unq$Species == "Proposis velutina"] <- "Prosopis velutina" 
scs_unq$Species[scs_unq$Species == "Robinia pseudoaccia"] <- "Robinia pseudoacacia"
scs_unq$Species[scs_unq$Species == "Cercis siliquatrum"] <- "Cercis siliquastrum"
scs_unq$Species[scs_unq$Species == "Lymantria disparasiatica"] <- "Lymantria dispar asiatica"
scs_unq$Species[scs_unq$Species == "Syrindodium filiformis"] <- "Syrindodium filiforme"
scs_unq$Species[scs_unq$Species == "Clerodendrum chinese"] <- "Clerodendrum chinense"
```

Look fixed list up again and get only species with exact matches in GBIF.

```{r, eval = FALSE}
gbif_lookup2 <- 
  pbapply::pblapply(unique(scs_unq$Species), 
                    rgbif::name_lookup, 
                    verbose = FALSE)

saveRDS(gbif_lookup2, "gbif_lookup2.rds")
```

```{r}
gbif_lookup2 <- readRDS("gbif_lookup2.rds")

name_match <- 
  sapply(1:length(unique(scs_unq$Species)), 
         function(i){
           
           unique(scs_unq$Species)[i] %in%
             c(gbif_lookup2[[i]]$data$species, 
               gbif_lookup2[[i]]$data$scientificName)
           
         })

unique(scs_unq$Species)[!name_match]

scs_unq_gbif <- 
  scs_unq[scs_unq$Species %in% unique(scs_unq$Species)[name_match],]
```

Get gbif taxon keys

```{r}
gbif_taxon_keys <- 
  unique(scs_unq_gbif$Species) %>% 
  rgbif::name_backbone_checklist() %>% 
  dplyr::filter(!matchType == "NONE") %>%
  dplyr::pull(usageKey) 
```

List country of occurrence for each species

```{r, warning=FALSE}
country_species <-
  pbapply::pblapply(unique(scs_unq_gbif$Species), function(sp){
    
    gbif_taxon_key <- 
      sp %>% 
      rgbif::name_backbone_checklist() %>% 
      dplyr::filter(!matchType == "NONE") %>%
      dplyr::pull(usageKey) 
    
    countries <- 
      rgbif::count_facet(gbif_taxon_key, 
                         by = "country", 
                         countries = 500)$country
    
    data.frame(sp = sp, 
               country = countries)
    
  }) %>% 
  do.call(rbind, .)

saveRDS(country_species, "country_species.rds")
```

```{r}
scs_unq_gbif$Official_country[!scs_unq_gbif$Official_country %in% 
                                rgbif::isocodes$name] %>% 
  unique
```

```{r}
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "United States of America"] <- "United States"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Venezuela"] <- "Venezuela, Bolivarian Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Vietnam"] <- "Viet Nam"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Tanzania"] <- "Tanzania, United Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "South Korea"] <- "Korea, Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Russia"] <- "Russian Federation"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Brunei"] <- "Brunei Darussalam"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Laos"] <- "Lao People's Democratic Republic"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "East Timor"] <- "Timor-Leste"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Bolivia"] <- "Bolivia, Plurinational State of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Ivory Coast"] <- "Cote d'Ivoire"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Macedonia"] <- "Macedonia, the former Yugoslav Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Moldova"] <- "Moldova, Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Democratic Republic of the Congo"] <- "Congo, the Democratic Republic of the"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Iran"] <- "Iran, Islamic Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Federal States of Micronesia"] <- "Micronesia, Federated States of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Czechia"] <- "Czech Republic"

scs_unq_gbif$iso2 <- 
  rgbif::isocodes$code[match(scs_unq_gbif$Official_country,
                             rgbif::isocodes$name)]

scs_unq_gbif$iso2[scs_unq_gbif$Official_country == "Kosovo"] <- "XK"
```

Match country names

```{r}
country_species <- readRDS("country_species.rds")

completeness_df <-
  lapply(unique(scs_unq_gbif$iso2), 
         function(cntr){
           
           inva_sp <-
             scs_unq_gbif$Species[scs_unq_gbif$iso2 == cntr] %>% 
             unique
           
           cntr_sp <-
             country_species$sp[country_species$country == cntr] %>% 
             unique
           
           sp_prop <- sum(inva_sp %in% cntr_sp)/length(cntr_sp) # double check if all inva_sp are in cntr_sp
           
           data.frame(country = iso2,
                      sp_prop = sp_prop)
           
         }) %>% 
  do.call(rbind, .)

write.csv(completeness_df, "completeness_df.csv", row.names = FALSE)
```
