---
title: "InvaCost Spatial Extrapolation"
author: "Gabriel Caetano, Ivan Jaric, Franck Courchamp"
date: "`r Sys.Date()`"
output: 
  pdf_document: default
  rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{pcpi} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

# To do

- Find country-level predictors for each impacted sector (WorldBank database? package wbstats)
- Filter appropriate data
- Filter only UN recognized countries? (Are these the only countries in WorldBank?)
- Solve Namibia
- Solve Kosovo
- Include instalation of all packages

# Set up

Install packages (turned off automatic evaluation so it doesn't try to install them every time)

```{r, eval = FALSE}
install.packages("magrittr")
install.packages("stringr")
install.packages("rgbif")
install.packages("pbapply")
install.packages("caret")
install.packages("forcats")
install.packages("wbstats")
```

Load packages

```{r}
library(magrittr)
library(rgbif)
library(ggplot2)
```

Load data

```{r}
inva_db <-
  invacost::getInvaCostVersion()
```

# Data Exploration

What does the database looks like?

```{r}
head(inva_db)
```

It seems the there are a few data points with multiple species, countries and impacted sectors. Let's create a new table with only unique combinations.

```{r}
scs_df <-
  data.frame(
    Species = inva_db$Species,
    Official_country = inva_db$Official_country,
    Impacted_sector  = inva_db$Impacted_sector)

scs_df <- scs_df[complete.cases(scs_df),]

scs_unq <-
  lapply(1:nrow(scs_df), function(r){
    
    row <- scs_df[r,]
    #print(row.names(row))
    row.names(row) <- NULL
    
    which_multi <- stringr::str_detect(row, "/")
    
    if(!any(which_multi)) return(row)
    
    split_cases <-
      sapply(row[which_multi], stringr::str_split, "/")
    
    out <-
      do.call(expand.grid, split_cases) %>% 
      data.frame(row[!which_multi] )
    
    out[match(colnames(out), names(row))]
    
  }) %>% 
  do.call(rbind, .)

scs_unq <- 
  scs_unq[!stringr::str_detect(scs_unq$Species, "\\."),]

dim(scs_unq)
```

Fix some typos and remove unspecified countries and impact sectors

```{r}
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Forestry " ] <- "Forestry"
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Foresty" ] <- "Forestry"
scs_unq$Impacted_sector[scs_unq$Impacted_sector == "Public and social welfare" ] <- "Public and Social Welfare"

scs_unq$Official_country[scs_unq$Official_country == "Kanya" ] <- "Kenya"
scs_unq$Official_country[scs_unq$Official_country == "Republic of Serbia" ] <- "Serbia"
scs_unq$Official_country[scs_unq$Official_country == "The Bahamas" ] <- "Bahamas"
scs_unq$Official_country[scs_unq$Official_country == "United Republic of Tanzania" ] <- "Tanzania"

scs_unq <- scs_unq[!scs_unq$Impacted_sector %in% c("Unspecified"),]
scs_unq <- scs_unq[!scs_unq$Official_country %in% c("31 countries",
                                                    "African Countries",
                                                    "Diverse",
                                                    "EU27+",
                                                    "Unspecified"),]

scs_unq <- scs_unq[!duplicated(scs_unq),]

dim(scs_unq)
```

# Completeness analysis

Look up species names in GBIF taxonomy (this may take a while)

```{r, eval = FALSE}
gbif_lookup <- 
  pbapply::pblapply(unique(scs_unq$Species), 
                    rgbif::name_lookup, 
                    verbose = FALSE)

saveRDS(gbif_lookup, "gbif_lookup.rds")
```

See which names found no match in GBIF

```{r, eval = FALSE}
gbif_lookup <- readRDS("gbif_lookup.rds")

name_match <- 
  sapply(1:length(unique(scs_unq$Species)), 
         function(i){
           
           unique(scs_unq$Species)[i] %in%
             c(gbif_lookup[[i]]$data$species, 
               gbif_lookup[[i]]$data$scientificName)
           
         })

unique(scs_unq$Species)[!name_match]
```

Fix mispellings

```{r}
# Mispellings
scs_unq$Species[scs_unq$Species == "Felix catus"] <- "Felis catus"
scs_unq$Species[scs_unq$Species == "Rarrus rattus"] <- "Rattus rattus"
scs_unq$Species[scs_unq$Species == "italicum"] <- "Arum italicum"
scs_unq$Species[scs_unq$Species == "Cylindroptunia sp."] <- "Cylindropuntia sp."
scs_unq$Species[scs_unq$Species == "Bos taurus "] <- "Bos taurus"
scs_unq$Species[scs_unq$Species == "Andean ?otato latent tymovirus"] <- "Andean potato latent tymovirus"
scs_unq$Species[scs_unq$Species == " Proposis juliflora"] <- "Proposis juliflora"
scs_unq$Species[scs_unq$Species == " Proposis velutina"] <- "Proposis velutina"
scs_unq$Species[scs_unq$Species == " Solenopsis richteri"] <- "Solenopsis richteri"
scs_unq$Species[scs_unq$Species == "Gaeumannomyces graminis\x86var.\x86tritici"] <- "Gaeumannomyces graminis var. tritici"
scs_unq$Species[scs_unq$Species == "Spartina\xa0spp."] <- "Spartina spp."
scs_unq$Species[scs_unq$Species == "Candidatus\xa0liberibacter"] <- "Candidatus liberibacter"
scs_unq$Species[scs_unq$Species == "Casuarina equisetifolia "] <- "Casuarina equisetifolia"
scs_unq$Species[scs_unq$Species == "Tilletia Indica"] <- "Tilletia indica"
scs_unq$Species[scs_unq$Species == "Ralstonia Solanacearum"] <- "Ralstonia solanacearum"
scs_unq$Species[scs_unq$Species == "Pacifastacus Leniusculus"] <- "Pacifastacus leniusculus"
scs_unq$Species[scs_unq$Species == "Opuntia ficus-indica "] <- "Opuntia ficus-indica"
scs_unq$Species[scs_unq$Species == "Blatella germanica"] <- "Blattella germanica"
scs_unq$Species[scs_unq$Species == "Peach  rosette  mosaic  nepovirus "] <- "Peach  rosette  mosaic  nepovirus"
scs_unq$Species[scs_unq$Species == "Oligonychus metasequoia"] <- "Oligonychus metasequoiae" 
scs_unq$Species[scs_unq$Species == "Proposis pallida"] <- "Prosopis pallida"
scs_unq$Species[scs_unq$Species == "Proposis gladulosa"] <- "Prosopis glandulosa"
scs_unq$Species[scs_unq$Species == "Proposis juliflora"] <- "Prosopis juliflora"
scs_unq$Species[scs_unq$Species == "Proposis velutina"] <- "Prosopis velutina" 
scs_unq$Species[scs_unq$Species == "Robinia pseudoaccia"] <- "Robinia pseudoacacia"
scs_unq$Species[scs_unq$Species == "Cercis siliquatrum"] <- "Cercis siliquastrum"
scs_unq$Species[scs_unq$Species == "Lymantria disparasiatica"] <- "Lymantria dispar asiatica"
scs_unq$Species[scs_unq$Species == "Syrindodium filiformis"] <- "Syringodium filiforme"
scs_unq$Species[scs_unq$Species == "Clerodendrum chinese"] <- "Clerodendrum chinense"
```

Look fixed list up again and get only species with exact matches in GBIF.

```{r, eval = FALSE}
gbif_lookup2 <- 
  pbapply::pblapply(unique(scs_unq$Species), 
                    rgbif::name_lookup, 
                    verbose = FALSE)

saveRDS(gbif_lookup2, "gbif_lookup2.rds")
```

```{r}
gbif_lookup2 <- readRDS("gbif_lookup2.rds")

name_match <- 
  sapply(1:length(unique(scs_unq$Species)), 
         function(i){
           
           unique(scs_unq$Species)[i] %in%
             c(gbif_lookup2[[i]]$data$species, 
               gbif_lookup2[[i]]$data$scientificName)
           
         })

unique(scs_unq$Species)[!name_match]

scs_unq_gbif <- 
  scs_unq[scs_unq$Species %in% unique(scs_unq$Species)[name_match],]

scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "United States of America"] <- "United States"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Venezuela"] <- "Venezuela, Bolivarian Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Vietnam"] <- "Viet Nam"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Tanzania"] <- "Tanzania, United Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "South Korea"] <- "Korea, Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Russia"] <- "Russian Federation"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Brunei"] <- "Brunei Darussalam"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Laos"] <- "Lao People's Democratic Republic"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "East Timor"] <- "Timor-Leste"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Bolivia"] <- "Bolivia, Plurinational State of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Ivory Coast"] <- "Cote d'Ivoire"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Macedonia"] <- "Macedonia, the former Yugoslav Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Moldova"] <- "Moldova, Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Democratic Republic of the Congo"] <- "Congo, the Democratic Republic of the"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Iran"] <- "Iran, Islamic Republic of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Federal States of Micronesia"] <- "Micronesia, Federated States of"
scs_unq_gbif$Official_country[scs_unq_gbif$Official_country == "Czechia"] <- "Czech Republic"

scs_unq_gbif$iso2 <- 
  rgbif::isocodes$code[match(scs_unq_gbif$Official_country,
                             rgbif::isocodes$name)]

scs_unq_gbif$iso2[scs_unq_gbif$Official_country == "Kosovo"] <- "XK"
```

Get GBIF taxon keys

```{r}
gbif_taxon_keys <- 
  unique(scs_unq_gbif$Species) %>% 
  rgbif::name_backbone_checklist() %>% 
  dplyr::filter(!matchType == "NONE") %>%
  dplyr::pull(usageKey) 
```

List country of occurrence for each species

```{r, warning = FALSE, eval = FALSE}
gbif_taxon_key <- 
  unique(scs_unq_gbif$Species) %>% 
  rgbif::name_backbone_checklist() %>% 
  dplyr::filter(!matchType == "NONE") %>%
  dplyr::pull(usageKey) 

pbapply::pblapply(1:length(gbif_taxon_key), function(i){
  
  countries <- 
    rgbif::count_facet(gbif_taxon_key[i], 
                       by = "country", 
                       countries = 249)
  
  if(sum(countries$count) == 0) return(NULL)
  
  out <-
    data.frame(sp = unique(scs_unq_gbif$Species)[i], 
               country = countries$country[countries$count > 0])
  
  write.csv(out, paste0("country_sp_", i, ".csv"), row.names = FALSE)
  
})

country_species <-
  pbapply::pblapply(list.files(pattern = "^country_sp_", 
                               full.names = TRUE), 
                    function(fl){
                      
                      read.csv(fl)
                      
                    }) %>% 
  do.call(rbind, .)

country_species <- country_species[complete.cases(country_species),]
scs_unq_gbif <- scs_unq_gbif[complete.cases(scs_unq_gbif),]

saveRDS(country_species, "country_species.rds")
```

Calculate proportion of sampled species per country

```{r}
country_species <- readRDS("country_species.rds")

completeness_df <-
  lapply(unique(scs_unq_gbif$iso2), 
         function(cntr){
           
           inva_sp <-
             scs_unq_gbif$Species[scs_unq_gbif$iso2 == cntr] %>% 
             unique
           
           cntr_sp <-
             country_species$sp[country_species$country == cntr] %>% 
             unique
           
           sp_prop <- sum(inva_sp %in% cntr_sp)/length(cntr_sp)
           
           data.frame(country = cntr,
                      sp_prop = sp_prop)
           
         }) %>% 
  do.call(rbind, .)

write.csv(completeness_df, "completeness_df.csv", row.names = FALSE)
```

Plot countries with more than 10% data completeness

```{r}
completeness_df[completeness_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()
```

Separate data by impacted sector

```{r}
completeness_sector_df <-
  lapply(unique(scs_unq_gbif$Impacted_sector), function(sect){
    
    scs_unq_sect <- 
      scs_unq_gbif[scs_unq_gbif$Impacted_sector == sect,]
    
    country_species_sect <- 
      country_species[country_species$sp %in% scs_unq_sect$Species,]
    
    completeness_df_this_sect <-
      lapply(unique(scs_unq_sect$iso2), 
             function(cntr){
               
               inva_sp <-
                 scs_unq_sect$Species[scs_unq_sect$iso2 == cntr] %>% 
                 unique
               
               cntr_sp <-
                 country_species_sect$sp[country_species_sect$country == cntr] %>% 
                 unique
               
               sp_prop <- sum(inva_sp %in% cntr_sp)/length(cntr_sp)
               
               data.frame(country = cntr,
                          sp_prop = sp_prop)
               
             }) %>% 
      do.call(rbind, .)
    
    completeness_df_this_sect$sector <- sect
    
    completeness_df_this_sect
    
  }) %>% 
  do.call(rbind, .)
```

Plot countries with more than 10% data completeness for each impacted sector

```{r}
completeness_sector_df[completeness_sector_df$sector == "Agriculture" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Environment" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Authorities-Stakeholders" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Public and Social Welfare" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Health" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Forestry" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()

completeness_sector_df[completeness_sector_df$sector == "Fishery" &
                         completeness_sector_df$sp_prop > 0.1,] %>% 
  ggplot(aes(x = forcats::fct_rev(forcats::fct_reorder(country, sp_prop)),
             y = sp_prop,
             fill = sp_prop)) +
  geom_col() +
  theme_classic()
```

# Cost distribution analysis

Divide records with multiple taxa, sector, environment

```{r}
psce_df <-
  data.frame(
    Phylum = inva_db$Phylum,
    Sector  = inva_db$Impacted_sector,
    Cost = inva_db$Cost_estimate_per_year_2017_USD_PPP,
    Environment = inva_db$Environment)

psce_df <- psce_df[complete.cases(psce_df),]

psce_unq <-
  lapply(1:nrow(psce_df), function(r){
    
    row <- psce_df[r,]
    #print(row.names(row))
    row.names(row) <- NULL
    
    which_multi <- stringr::str_detect(row, "/")
    
    if(!any(which_multi)) return(row)
    
    split_cases <-
      sapply(row[which_multi], stringr::str_split, "/")
    
    out <-
      do.call(expand.grid, split_cases) %>% 
      data.frame(row[!which_multi] )
    
    out[match(colnames(out), names(row))]
    
  }) %>% 
  do.call(rbind, .)

psce_unq$Sector[psce_unq$Sector == "Forestry " ] <- "Forestry"
psce_unq$Environment[psce_unq$Environment == "Semi-aquatic" ] <- "Semi-Aquatic"

dim(psce_unq)
```

Group Phylla into broader groups

```{r}
psce_unq$Phylum %>% unique

psce_unq <- psce_unq[!psce_unq$Phylum %in% c("Diverse", "Unspecified"),]
psce_unq <- psce_unq[!psce_unq$Environment %in% c("Diverse", "Unspecified", "Semi-Aquatic"),]

psce_unq$Group <- NA
psce_unq$Group[psce_unq$Phylum == "Chordata"] <- "Vertebrates"

psce_unq$Group[psce_unq$Phylum == "Arthropoda"] <- "Arthropods"

psce_unq$Group[psce_unq$Phylum == "Nematoda"] <- "Invertebrates"          
psce_unq$Group[psce_unq$Phylum == "Platyhelminthes"] <- "Invertebrates"
psce_unq$Group[psce_unq$Phylum == "Annelida"] <- "Invertebrates"
psce_unq$Group[psce_unq$Phylum == "Cnidaria"] <- "Invertebrates"
psce_unq$Group[psce_unq$Phylum == "Mollusca"] <- "Invertebrates"  

psce_unq$Group[psce_unq$Phylum == "Tracheophyta"] <- "Plants" 
psce_unq$Group[psce_unq$Phylum == "Ochrophyta"] <- "Plants"
psce_unq$Group[psce_unq$Phylum == "Chlorophyta"] <- "Plants"

psce_unq$Group[psce_unq$Phylum == "Oomycota"] <- "Fungi"     
psce_unq$Group[psce_unq$Phylum == "Basidiomycota"] <- "Fungi"
psce_unq$Group[psce_unq$Phylum == "Basidiomycota"] <- "Fungi"
psce_unq$Group[psce_unq$Phylum == "Chytridiomycota"] <- "Fungi"
psce_unq$Group[psce_unq$Phylum == "Ascomycota"] <- "Fungi"
psce_unq$Group[psce_unq$Phylum == "Ascomyceta"] <- "Fungi"

psce_unq$Group[psce_unq$Phylum == "Proteobacteria"] <- "Microbes" 
psce_unq$Group[psce_unq$Phylum == "Cressdnaviricota"] <- "Microbes"            
psce_unq$Group[psce_unq$Phylum == "Negarnaviricota"] <- "Microbes"   
psce_unq$Group[psce_unq$Phylum == "Pisuviricota"] <- "Microbes"       
psce_unq$Group[psce_unq$Phylum == "Kitrinoviricota"] <- "Microbes"    
psce_unq$Group[psce_unq$Phylum == "Nucleocytoviricota"] <- "Microbes"           
psce_unq$Group[psce_unq$Phylum == "Peploviricota"] <- "Microbes" 
```

Plot cost distribution by group and sector, for each environment

```{r}
psce_unq %>% 
  ggplot(aes(x = Sector, 
             y = log(Cost))) +
  geom_boxplot() + 
  theme_classic()

psce_unq %>% 
  ggplot(aes(x = Group, 
             y = log(Cost))) +
  geom_boxplot() + 
  theme_classic()

psce_unq %>% 
  ggplot(aes(x = Sector, 
             y = log(Cost),
             fill = Group)) +
  geom_boxplot() + 
  theme_classic()

psce_unq[psce_unq$Environment == "Aquatic",] %>% 
  ggplot(aes(x = Sector, 
             y = log(Cost),
             fill = Group)) +
  geom_boxplot() + 
  theme_classic()

psce_unq[psce_unq$Environment == "Terrestrial",] %>% 
  ggplot(aes(x = Sector, 
             y = log(Cost),
             fill = Group)) +
  geom_boxplot() + 
  theme_classic()
```

# Fit random forest without country data

Log and scale cost data

```{r}
set.seed(1)

psce_unq$log_Cost <- log(psce_unq$Cost)
psce_unq$log_Cost <- psce_unq$log_Cost/max(psce_unq$log_Cost)
```

Partition data

```{r}
part_ind <- 
  caret::createDataPartition(y=psce_unq$log_Cost, 
                             p=0.7, 
                             list=FALSE)

psce_train <- psce_unq[part_ind, ]
psce_test <- psce_unq[-part_ind, ]
```

Fit Random Forest model

```{r, eval = FALSE}
set.seed(1)

psce_rf <- 
  caret::train(log_Cost ~ Sector + Group + Environment, 
               method='rf', 
               trControl= caret::trainControl(method = 'repeatedcv', 
                                              number = 5, 
                                              repeats = 3),
               metric='RMSE',
               data = psce_train)

saveRDS(psce_rf, "psce_rf.rds")
```

Cross-validate

```{r}
psce_rf <- readRDS("psce_rf.rds")

psce_rf$finalModel

pred_psce_rf <- 
  predict(psce_rf, 
          psce_test[, -3])

1 - mean((pred_psce_rf - psce_test$log_Cost)^2)/var(psce_test$log_Cost)
```

```{r}
psce_boruta <- 
  Boruta::Boruta(log_Cost ~ Sector + Group + Environment,
                 psce_train)

plot(psce_boruta)
```

# Get country data from WorldBank

